# VCFG Builder 改善計画（次フェーズ案）

第1段階の実装は完了しました。ここから追加で着手すべき変更・リファクタリングを優先度順に整理します。各項目は現行コードでの足りない点を根拠に挙げています。

## A. 表示とデバッグの分かりやすさ
- **投機／ロールバックエッジに意味ラベルを付与**  
  現状 `spec` / `rollback` エッジはいずれも無ラベルで、UI が「予測ミス」「正帰還」などを表示できない。`vcfg-builder/src/vcfg.ts:147-172`。  
  → `label` に `mispredict`, `rollback` 理由などを設定し、ビュー層が説明ツールチップを出せるようにする。
- **投機コンテキスト ID のメタデータ化**  
  ノード ID の文字列末尾（例: `@spec0`）だけに依存しているためパースが必要。`vcfg-builder/src/vcfg.ts:135-148`。  
  → ノードに `specContextId` フィールドを追加し、UI/解析コアが文字列パースなしで系統を判別できるようにする（下位互換として ID も維持）。

## B. スケーラビリティと安全性
- **投機展開の上限ガードと統計**  
  予算は `windowSize` のみで、総ノード数や再帰深さの上限チェックがない。大規模入力ではメモリ爆発の可能性がある。`vcfg-builder/src/vcfg.ts:112-172`。  
  → 最大ノード・エッジ数のソフトリミットと、リミット到達時の警告を `StaticGraph` 付随メタデータで返す。
- **ジャンプ先解決の拡張**  
  現状 `jmp` はラベル/即値の静的解決のみで、実行時計算に依存する形式は `ParseError` になる。`vcfg-builder/src/parser.ts:74-80`、`vcfg-builder/src/vcfg.ts:38-44`。  
  → 解析側が扱える抽象ジャンプ（例: 未解決を "dynamic" としてノードを立てる）を導入し、エラーではなくグラフ上のハンドリングに落とし込む。

## C. エラー伝搬とユースケース整備（現状確認を反映）
- **ユーザー向けエラーメッセージ整形（未着手）**  
  `ParseError` の detail に行番号は入る。UI 側では `app/lib/analysis-client.ts:23-34` で例外を捕捉し、`AnalysisResult.error` にラップして返却するまで完了済み。  
  → 追加タスクはメッセージ文面のテンプレ整備とローカライズのみ（機能欠落ではない）。

- **ドキュメントと API 表面の同期（解決済み）**  
  `schemaVersion` 付与は `analyze()` ファサードで実装済み（同上）。`buildVCFG` 単体はグラフ生成の低レイヤ API と位置付ける。  
  → 今後はドキュメントの表現を「analyze() でスキーマ付与済み」に統一し、重複記述を避ける。

## D. テストと検証の拡充
- **パフォーマンス／上限テスト**  
  現在のテストは API 形状・基本分岐・spbarr などの機能確認のみで、10k 行級や大きな `windowSize` の計測がない。`vcfg-builder/src/index.test.ts:6-302`。  
  → 大型入力を生成するベンチと、リミット発動時の期待挙動（警告・エッジ数上限）を CI に追加。
- **スナップショットの人間可読化**  
  期待グラフを文字列比較していないため、リグレッション検知が難しい。`vcfg-builder/src/index.test.ts:155-302`。  
  → 代表ケースの `StaticGraph` を JSON スナップショット化し、`type` / `label` / `specOrigin` の目視確認をしやすくする。
