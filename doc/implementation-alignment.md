# 実装整合性改善計画（理論未参照でも読める版）

対象リポジトリ: `/Users/taisii/Projects/Private/research`
注: 2025-11-24 時点で stack-guard / legacy-meta モードは実装から削除済みで、speculationMode は discard 固定、specMode は light 固定になっている。specContext の push/pop はログ専用で、実行セマンティクスは投機カウンタのみ。

## 前提となるモデルの要点（実装者向けの最小まとめ）
- **関係格子の値**: `Bot`, `EqLow`, `Diverge`, `EqHigh`, `Leak`, `Top`。  
  - `Leak` は吸収元（どこと結合しても `Leak`）。  
  - `Diverge ⊔ EqHigh = EqHigh`（Low の分岐に High が混ざれば High に引き上げ）。  
  - `EqHigh ⊔ Leak = Leak`。  
  - `Top` は「解析不能／情報不足」で、違反とは区別する。
- **観測履歴の更新**: NS 実行はベースラインを記録、SP 実行はベースラインからの逸脱を検査。  
  - NS 側: 観測値が High なら履歴を High に上げる（Leak を含む）。  
  - SP 側: ベースラインが Low なのに SP 観測が High なら即 `Leak`。既に `Leak` なら維持。  
  - 履歴マップのマージは通常の join ではなく、この専用規則を使う。
- **違反判定**: 解析途中で `Leak` を見つけたら違反。`Top` は警告または不確定扱いにとどめる。
- **投機ガード**: Pruning-VCFG では rollback を扱わず、投機長カウンタ `specWindow` が 0 未満になる遷移（spec エッジ）を遮断する。NS エッジはモードを維持したまま通過可能。
- **不要モード**: `stack-guard`（投機スタック検証）と `legacy-meta`（前展開グラフ）は廃止済み。残っているのは `speculationMode: "discard"` と `specMode: "light"` の最小構成のみ。

## 今後のタスク（未完のみ）
1. **`specWindow` と深さ上限の扱いを明文化**  
   - 現実装は `specWindow` カウンタのみを使用し、深さ上限 (`maxSpeculationDepth`) は未実装。仕様書にその前提を明記し、必要なら導入是非を決める。
2. **初期化規則の記述強化**  
   - `doc/project.md` にポリシー優先順位とデフォルト格子（レジスタ=EqLow、メモリ=EqHigh、未設定=Bot）を簡潔に追記し、`state.ts` のコメントと合わせる。
3. **テスト補完**  
   - 新しい格子/観測セマンティクスの境界ケースを `sni-engine/tests/*` に追加し、モード削除後のスナップショットを更新する。`Top` は警告のみで違反にならないことをテストで固定。
4. **ドキュメント再整理**  
   - 本ファイルと `doc/project.md` に、採用している格子演算・観測規則・パラメータの一覧表を追加し、旧モードに関する記述を残さない。

## 進め方の提案
- まず 1–3 で解析結果の正しさを担保し、その後 5 でモード削除を一括リファクタ。  
- 4 と 6 は挙動の安全面に直結するため、並行で小さく進めてもよい。  
- テスト/ドキュメント更新（8–9）は最後にまとめて適用し、スナップショット崩れを一度に解消する。

## 残課題メモ
- 解析状態キー圧縮（k-limiting）や投機窓の最適化は本計画の外とし、別途検討。  
- `Top` を警告にする場合の UI 表示（色・文言）を決める必要あり。
